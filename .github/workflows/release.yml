name: release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  github-release:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build workflow
        id: wait_build
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = "build.yml";

            const tag = context.ref.replace("refs/tags/", "");
            const expectedSha = context.sha;

            const pollIntervalMs = 15 * 1000;
            const maxAttempts = 120;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id,
                per_page: 20,
              });

              const runs = data.workflow_runs || [];
              const matchingRuns = runs.filter((run) => {
                return (
                  run.event === "push" &&
                  run.head_branch === tag &&
                  run.head_sha === expectedSha
                );
              });

              if (matchingRuns.length === 0) {
                core.info(
                  `No matching build.yml run yet for ${tag}@${expectedSha} (attempt ${attempt}/${maxAttempts})`,
                );
              } else {
                const run = matchingRuns[0];
                core.info(
                  `Found build.yml run ${run.id} (status=${run.status}, conclusion=${run.conclusion})`,
                );

                if (run.status === "completed") {
                  if (run.conclusion !== "success") {
                    throw new Error(
                      `build.yml run ${run.id} completed with conclusion=${run.conclusion}`,
                    );
                  }

                  core.setOutput("run_id", String(run.id));
                  return;
                }
              }

              await new Promise((resolve) => setTimeout(resolve, pollIntervalMs));
            }

            throw new Error(
              `Timed out waiting for build.yml to complete for ${tag}@${expectedSha}`,
            );

      - name: Find helm-chart artifact
        id: find_artifact
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          RUN_ID: ${{ steps.wait_build.outputs.run_id }}
        with:
          script: |
            const run_id = Number(process.env.RUN_ID || "");
            if (!run_id) {
              throw new Error("Missing RUN_ID from wait_build step output.");
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id,
              per_page: 100,
            });

            const artifacts = data.artifacts || [];
            const artifact = artifacts.find((a) => a.name === "helm-chart");
            if (!artifact) {
              throw new Error(`helm-chart artifact not found for run_id=${run_id}`);
            }

            core.setOutput("artifact_id", String(artifact.id));

      - name: Download helm-chart artifact
        shell: bash
        env:
          ARTIFACT_ID: ${{ steps.find_artifact.outputs.artifact_id }}
        run: |
          set -euo pipefail

          url="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/artifacts/${ARTIFACT_ID}/zip"

          curl -fsSL \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            -o helm-chart.zip \
            "${url}"

          unzip -q helm-chart.zip

          test -d dist
          ls -1 dist/*.tgz >/dev/null
          ls -1 dist/*.spdx.json >/dev/null

      - name: Generate release body
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = context.ref.replace("refs/tags/", "");

            const pagesUrl = `https://${owner}.github.io/${repo}`;
            const image = `ghcr.io/${owner}/gpubox:${tag}`;

            const { data } = await github.rest.repos.generateReleaseNotes({
              owner,
              repo,
              tag_name: tag,
            });

            const notes = (data && data.body ? data.body : "").trim();

            const bodyLines = [
              "## Install",
              "",
              "Helm chart repo (GitHub Pages):",
              "",
              "```bash",
              `helm repo add gpubox ${pagesUrl}`,
              "helm repo update",
              "",
              "helm upgrade --install gpubox gpubox/gpubox \\",
              "  --namespace gpubox \\",
              "  --create-namespace",
              "```",
              "",
              "Container image:",
              "",
              `\`${image}\``,
              "",
              "## Release notes",
              "",
              notes,
              "",
            ];

            const body = bodyLines.join("\n");

            fs.writeFileSync("release-body.md", body, { encoding: "utf8" });
            core.info("Wrote release-body.md");

      - name: Create GitHub Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          bodyFile: release-body.md
          artifacts: "dist/*.tgz,dist/*.spdx.json"
          allowUpdates: true
          artifactErrorsFailBuild: true
