name: release

on:
  workflow_call:
    inputs:
      tag:
        description: Release tag (for example, v1.2.3)
        required: true
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ inputs.tag }}
  cancel-in-progress: false

jobs:
  github-release:
    if: startsWith(inputs.tag, 'v')
    runs-on: ubuntu-latest
    steps:
      - name: Download helm-chart artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: helm-chart
          path: .
          merge-multiple: true

      - name: Prepare chart files
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          # The build workflow uploads `dist/*.tgz` and `dist/*.spdx.json`, but the
          # artifact payload is flattened to the file basenames when downloaded.
          # Normalize into `dist/` so the release upload globs are stable.
          if compgen -G "dist/*.tgz" >/dev/null && compgen -G "dist/*.spdx.json" >/dev/null; then
            echo "Found chart artifacts in dist/."
          else
            mkdir -p dist

            tgz_files=( *.tgz )
            sbom_files=( *.spdx.json )

            if [ ${#tgz_files[@]} -eq 0 ] || [ ${#sbom_files[@]} -eq 0 ]; then
              echo "Expected chart artifacts not found in workspace:"
              ls -la
              exit 1
            fi

            mv -f *.tgz dist/
            mv -f *.spdx.json dist/
          fi

          ls -la dist
          ls -1 dist/*.tgz >/dev/null
          ls -1 dist/*.spdx.json >/dev/null

      - name: Generate release body
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = "${{ inputs.tag }}";

            const pagesUrl = `https://${owner}.github.io/${repo}`;
            const image = `ghcr.io/${owner}/gpubox:${tag}`;

            const { data } = await github.rest.repos.generateReleaseNotes({
              owner,
              repo,
              tag_name: tag,
            });

            const notes = (data && data.body ? data.body : "").trim();

            const bodyLines = [
              "## Install",
              "",
              "Helm chart repo (GitHub Pages):",
              "",
              "```bash",
              `helm repo add gpubox ${pagesUrl}`,
              "helm repo update",
              "",
              "helm upgrade --install gpubox gpubox/gpubox \\",
              "  --namespace gpubox \\",
              "  --create-namespace",
              "```",
              "",
              "Container image:",
              "",
              `\`${image}\``,
              "",
              "## Release notes",
              "",
              notes,
              "",
            ];

            const body = bodyLines.join("\n");

            fs.writeFileSync("release-body.md", body, { encoding: "utf8" });
            core.info("Wrote release-body.md");

      - name: Create GitHub Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          bodyFile: release-body.md
          omitDraftDuringUpdate: true
          omitBodyDuringUpdate: true
          artifacts: "dist/*.tgz,dist/*.spdx.json"
          allowUpdates: true
          artifactErrorsFailBuild: true
